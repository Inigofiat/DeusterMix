<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Recetas - Deustermix</title>
</head>
<body style="font-family: Arial, sans-serif; margin: 0; padding: 0; background: url('https://www.comunicare.es/wp-content/uploads/2020/10/hortalizas-y-frutas.jpg') no-repeat center center fixed; background-size: cover;">
    <!-- Header compartido -->
    <header style="position: fixed; top: 0; left: 0; width: 100%; z-index: 10; display: flex; justify-content: flex-start; align-items: center; background-color: rgba(248, 249, 250, 0.9); padding: 15px 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); font-size: 1em; height: 80px;">
        <a href="/principal" style="text-decoration: none; color: black; font-weight: bold; margin-right: 1030px; transition: transform 0.3s ease, color 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.color='#ff7043';" onmouseout="this.style.transform='scale(1)'; this.style.color='black';">
            <h1 style="margin: 0; font-size: 1.5em;">Deustermix</h1>
        </a>
        <nav style="display: flex; gap: 20px;">
            <a href="/principal" style="text-decoration: none; color: black; font-weight: bold; transition: transform 0.3s ease, color 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.color='#ff7043';" onmouseout="this.style.transform='scale(1)'; this.style.color='#333';">Inicio</a>
            <a href="/recetas" style="text-decoration: none; color: black; font-weight: bold; transition: transform 0.3s ease, color 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.color='#ff7043';" onmouseout="this.style.transform='scale(1)'; this.style.color='#333';">Recetas</a>
            <a href="/libros" style="text-decoration: none; color: black; font-weight: bold; transition: transform 0.3s ease, color 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.color='#ff7043';" onmouseout="this.style.transform='scale(1)'; this.style.color='#333';">Libros</a>
            <a href="/perfil" style="text-decoration: none; color: black; font-weight: bold; transition: transform 0.3s ease, color 0.3s ease;" onmouseover="this.style.transform='scale(1.1)'; this.style.color='#ff7043';" onmouseout="this.style.transform='scale(1)'; this.style.color='#333';">Mi Perfil</a>
        </nav>
    </header>

    <div class="container" style="max-width: 1200px; margin: 120px auto 20px; padding: 20px; background-color: rgba(255, 255, 255, 0.9); border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <h1 style="text-align: center; color: #ff7043; margin-bottom: 20px;">Consultar Recetas</h1>
        
        <div class="search-bar" style="display: flex; align-items: center; margin-bottom: 20px; gap: 10px; max-width: 600px; margin-left: auto; margin-right: auto;">
            <input type="text" id="search-recipes" placeholder="Escribe el nombre de la receta..." style="flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
            <button type="button" class="search-button" style="padding: 10px 15px; background-color: #ff7043; border: none; border-radius: 4px; cursor: pointer;">
                <img src="https://icones.pro/wp-content/uploads/2021/02/loupe-et-icone-de-recherche-de-couleur-orange.png" alt="Buscar" class="search-icon" style="width: 20px; height: 20px;">
            </button>
        </div>
        
        <!-- Loading indicator -->
        <div id="loading" style="text-align: center; display: none;">
            <p>Cargando recetas...</p>
        </div>
        
        <!-- Error message container -->
        <div id="error-container" style="display: none; color: red; text-align: center; margin: 20px 0;"></div>
        
        <!-- Recipe container -->
        <div id="recipe-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <!-- Recipes will be dynamically loaded here -->
        </div>
        
        <!-- No results message -->
        <div id="no-results" style="display: none; text-align: center; margin: 20px 0;">
            <p>No se encontraron recetas que coincidan con tu búsqueda.</p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const recipeContainer = document.getElementById("recipe-container");
            const searchInput = document.getElementById("search-recipes");
            const searchButton = document.querySelector(".search-button");
            const loadingIndicator = document.getElementById("loading");
            const errorContainer = document.getElementById("error-container");
            const noResultsMessage = document.getElementById("no-results");
            
            // Variable para almacenar IDs de recetas guardadas por el usuario
            let savedRecipeIds = new Set();
            
            // Comprobar estado de autenticación al cargar la página
            (async function checkAuthStatus() {
                const token = getUserToken();
                if (!token) {
                    console.log("No se encontró token de usuario");
                    
                    // Buscar en la URL si hay un token como parámetro de consulta
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('token')) {
                        const newToken = urlParams.get('token');
                        localStorage.setItem('userToken', newToken);
                        console.log("Token obtenido de la URL y guardado");
                        // Recargar la página sin los parámetros para limpiar la URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } else {
                    // Verificar si el token es válido
                    try {
                        const response = await fetch('/auth/validate-token', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        
                        if (!response.ok) {
                            console.log("Token inválido, se eliminará");
                            localStorage.removeItem('userToken');
                            sessionStorage.removeItem('userToken');
                        } else {
                            console.log("Usuario autenticado correctamente");
                        }
                    } catch (error) {
                        console.log("Error al validar token, continuando sin verificación");
                    }
                }
            })();
            
            // Función para obtener el token de usuario del almacenamiento local o de la cookie
            function getUserToken() {
                // Primero intenta obtenerlo del localStorage
                const token = localStorage.getItem('userToken');
                if (token) {
                    return token;
                }
                
                // Si no está en localStorage, intentar obtenerlo de las cookies
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith('userToken=')) {
                        return cookie.substring('userToken='.length, cookie.length);
                    }
                }
                
                // Verificar si hay un token en la URL (por si se pasa como parámetro)
                const urlParams = new URLSearchParams(window.location.search);
                const tokenParam = urlParams.get('token');
                if (tokenParam) {
                    // Guardar en localStorage para futuras solicitudes
                    localStorage.setItem('userToken', tokenParam);
                    return tokenParam;
                }
                
                // Verificar si hay un token almacenado en sessionStorage
                const sessionToken = sessionStorage.getItem('userToken');
                if (sessionToken) {
                    return sessionToken;
                }
                
                return null;
            }
            
            // Función para cargar las recetas guardadas por el usuario
            async function loadSavedRecipes() {
                const token = getUserToken();
                if (!token) {
                    console.log("Usuario no autenticado");
                    return;
                }
                
                try {
                    // Obtener el email del usuario actual desde la sesión si está disponible
                    let userEmail = localStorage.getItem('userEmail');
                    
                    // Decidir qué endpoint usar según la información disponible
                    let endpoint;
                    let headers = {};
                    
                    if (userEmail) {
                        endpoint = `/api/cliente/${encodeURIComponent(userEmail)}/recetas-guardadas`;
                    } else {
                        endpoint = '/api/cliente/recetas-guardadas';
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    console.log("Solicitando recetas guardadas del endpoint:", endpoint);
                    
                    const response = await fetch(endpoint, { headers });
                    
                    if (!response.ok) {
                        // Si falla el primer intento, intentar con el otro método
                        if (!userEmail) {
                            console.log("Intento alternativo: obteniendo recetas guardadas a través de parámetro tokenUsuario");
                            const altResponse = await fetch(`/api/recetas-guardadas?tokenUsuario=${encodeURIComponent(token)}`);
                            if (altResponse.ok) {
                                const savedRecipes = await altResponse.json();
                                savedRecipeIds = new Set(savedRecipes.map(recipe => recipe.id));
                                console.log("Recetas guardadas cargadas (método alternativo):", savedRecipeIds);
                                updateHeartIcons();
                                return;
                            }
                        }
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const savedRecipes = await response.json();
                    savedRecipeIds = new Set(savedRecipes.map(recipe => recipe.id));
                    console.log("Recetas guardadas cargadas:", savedRecipeIds);
                    
                    // Actualizar los iconos de corazón si las recetas ya están cargadas
                    updateHeartIcons();
                    
                } catch (error) {
                    console.error("Error al cargar recetas guardadas:", error);
                    // A pesar del error, continuamos con la carga de recetas normales
                }
            }
            
            // Función para actualizar los iconos de corazón según las recetas guardadas
            function updateHeartIcons() {
                const heartButtons = document.querySelectorAll('.save-recipe');
                heartButtons.forEach(button => {
                    const recipeId = button.getAttribute('data-id');
                    const icon = button.querySelector('img');
                    
                    if (savedRecipeIds.has(parseInt(recipeId))) {
                        icon.style.opacity = '1';
                        icon.src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Love_Heart_symbol.svg/640px-Love_Heart_symbol.svg.png';
                        button.setAttribute('data-saved', 'true');
                    } else {
                        icon.style.opacity = '0.6';
                        button.setAttribute('data-saved', 'false');
                    }
                });
            }
            
            // Function to fetch and display recipes
            async function fetchRecipes(searchTerm = "") {
                try {
                    // Show loading indicator
                    loadingIndicator.style.display = "block";
                    recipeContainer.style.display = "none";
                    errorContainer.style.display = "none";
                    noResultsMessage.style.display = "none";
                    
                    // Fetch recipes from API
                    const response = await fetch('/api/recetas');
                    
                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }
                    
                    const recipes = await response.json();
                    
                    // Filter recipes if search term exists
                    const filteredRecipes = searchTerm 
                        ? recipes.filter(recipe => 
                            recipe.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (recipe.descripcion && recipe.descripcion.toLowerCase().includes(searchTerm.toLowerCase()))
                          )
                        : recipes;
                    
                    // Hide loading indicator
                    loadingIndicator.style.display = "none";
                    
                    // Clear current recipes
                    recipeContainer.innerHTML = "";
                    
                    // Display no results message if needed
                    if (filteredRecipes.length === 0) {
                        noResultsMessage.style.display = "block";
                        return;
                    }
                    
                    // Display recipes
                    recipeContainer.style.display = "grid";
                    
                    filteredRecipes.forEach(recipe => {
                        const recipeCard = document.createElement("div");
                        recipeCard.className = "recipe-card";
                        recipeCard.style = `
                            border: 2px solid #ff7043;
                            border-radius: 8px;
                            overflow: hidden;
                            background-color: white;
                            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                            transition: transform 0.3s ease;
                            display: flex;
                            flex-direction: column;
                            height: 100%;
                        `;
                        
                        // Use default image if none provided
                        const imageUrl = recipe.imageUrl || 'https://via.placeholder.com/300x200?text=Deustermix';
                        
                        // Verificar si la receta está guardada
                        const isSaved = savedRecipeIds.has(recipe.id);
                        const heartOpacity = isSaved ? '1' : '0.6';
                        
                        recipeCard.innerHTML = `
                            <img src="${imageUrl}" alt="${recipe.nombre}" style="width: 100%; height: 200px; object-fit: cover;">
                            <div style="padding: 15px; display: flex; flex-direction: column; flex-grow: 1;">
                                <h3 style="font-size: 18px; margin: 0 0 10px; color: #333;">${recipe.nombre}</h3>
                                <p style="font-size: 14px; color: #666; flex-grow: 1; margin-bottom: 15px;">
                                    ${recipe.descripcion || 'Sin descripción disponible'}
                                </p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <a href="/receta/${recipe.id}" style="
                                        padding: 8px 16px;
                                        background-color: #ff7043;
                                        color: white;
                                        text-decoration: none;
                                        border-radius: 4px;
                                        display: inline-block;
                                        transition: background-color 0.3s;
                                    ">Ver receta</a>
                                    <button class="save-recipe" data-id="${recipe.id}" data-saved="${isSaved}" style="
                                        background: none;
                                        border: none;
                                        cursor: pointer;
                                    ">
                                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Love_Heart_symbol.svg/640px-Love_Heart_symbol.svg.png" 
                                            alt="Guardar" 
                                            style="width: 24px; height: 24px; opacity: ${heartOpacity}; transition: opacity 0.3s;">
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        // Hover effect
                        recipeCard.addEventListener('mouseenter', () => {
                            recipeCard.style.transform = 'translateY(-5px)';
                        });
                        
                        recipeCard.addEventListener('mouseleave', () => {
                            recipeCard.style.transform = 'translateY(0)';
                        });
                        
                        // Add to container
                        recipeContainer.appendChild(recipeCard);
                        
                        // Add save recipe functionality
                        const saveButton = recipeCard.querySelector('.save-recipe');
                        saveButton.addEventListener('click', async (e) => {
                            e.preventDefault();
                            
                            const token = getUserToken();
                            if (!token) {
                                // Mostrar mensaje para iniciar sesión
                                const message = document.createElement('div');
                                message.textContent = 'Debes iniciar sesión para guardar recetas';
                                message.style = `
                                    position: fixed;
                                    top: 100px;
                                    left: 50%;
                                    transform: translateX(-50%);
                                    background-color: #f44336;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 4px;
                                    z-index: 100;
                                `;
                                document.body.appendChild(message);
                                
                                // Eliminar mensaje después de 2 segundos
                                setTimeout(() => {
                                    document.body.removeChild(message);
                                }, 2000);
                                
                                return;
                            }
                            
                            try {
                                const recipeId = saveButton.getAttribute('data-id');
                                const isSaved = saveButton.getAttribute('data-saved') === 'true';
                                
                                // Si ya está guardada, no hacer nada (puedes implementar "desguardar" si quieres)
                                if (isSaved) {
                                    console.log("La receta ya está guardada");
                                    return;
                                }
                                
                                // Intentamos varios formatos para asegurar compatibilidad con el backend
                                let response;
                                try {
                                    // Primer intento: usando el token en el cuerpo como tokenUsuario
                                    response = await fetch(`/api/recetas/guardar/${recipeId}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/x-www-form-urlencoded'
                                        },
                                        body: `tokenUsuario=${encodeURIComponent(token)}`
                                    });
                                    
                                    if (!response.ok) {
                                        // Segundo intento: usando el token en la cabecera Authorization
                                        response = await fetch(`/api/recetas/guardar/${recipeId}`, {
                                            method: 'POST',
                                            headers: {
                                                'Authorization': `Bearer ${token}`
                                            }
                                        });
                                    }
                                    
                                    if (!response.ok) {
                                        // Tercer intento: usando la ruta completa del controlador
                                        response = await fetch(`/api/recetas/guardar/${recipeId}?tokenUsuario=${encodeURIComponent(token)}`, {
                                            method: 'POST'
                                        });
                                    }
                                } catch (fetchError) {
                                    console.error('Error en la solicitud fetch:', fetchError);
                                    throw fetchError;
                                }
                                
                                if (response.ok) {
                                    // Actualizar el Set de recetas guardadas
                                    savedRecipeIds.add(parseInt(recipeId));
                                    
                                    // Visual feedback
                                    const icon = saveButton.querySelector('img');
                                    icon.style.opacity = '1';
                                    saveButton.setAttribute('data-saved', 'true');
                                    
                                    // Show a temporary message
                                    const message = document.createElement('div');
                                    message.textContent = 'Receta guardada';
                                    message.style = `
                                        position: fixed;
                                        top: 100px;
                                        left: 50%;
                                        transform: translateX(-50%);
                                        background-color: #4CAF50;
                                        color: white;
                                        padding: 10px 20px;
                                        border-radius: 4px;
                                        z-index: 100;
                                    `;
                                    document.body.appendChild(message);
                                    
                                    // Remove message after 2 seconds
                                    setTimeout(() => {
                                        document.body.removeChild(message);
                                    }, 2000);
                                }
                            } catch (error) {
                                console.error('Error al guardar la receta:', error);
                            }
                        });
                    });
                    
                    // Actualizar los corazones después de cargar las recetas
                    updateHeartIcons();
                    
                } catch (error) {
                    console.error("Error loading recipes:", error);
                    loadingIndicator.style.display = "none";
                    errorContainer.textContent = "Error al cargar las recetas. Por favor, inténtalo más tarde.";
                    errorContainer.style.display = "block";
                }
            }
            
            // Cargar primero las recetas guardadas y luego todas las recetas
            loadSavedRecipes().then(() => {
                fetchRecipes();
            });
            
            // Search functionality
            searchButton.addEventListener("click", () => {
                fetchRecipes(searchInput.value.trim());
            });
            
            // Enable search on Enter key
            searchInput.addEventListener("keyup", (event) => {
                if (event.key === "Enter") {
                    fetchRecipes(searchInput.value.trim());
                }
            });
        });
    </script>
</body>
</html>